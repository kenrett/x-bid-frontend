name: Frontend CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit production dependencies
        run: npm audit --omit=dev

      - name: Find backend OpenAPI artifact run (PR)
        if: ${{ github.event_name == 'pull_request' }}
        id: backend-run
        uses: actions/github-script@v7
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
          GH_TOKEN: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
        with:
          script: |
            const [owner, repo] = process.env.BACKEND_REPO.split("/");
            const headSha = context.payload.pull_request.head.sha;
            const token = process.env.GH_TOKEN;

            const runs = await github.request("GET /repos/{owner}/{repo}/actions/runs", {
              owner,
              repo,
              event: "pull_request",
              head_sha: headSha,
              per_page: 50,
              headers: { authorization: `Bearer ${token}` },
            });
            const run = runs.data.workflow_runs?.[0];
            if (!run) {
              core.setFailed(`No backend workflow run found for head_sha=${headSha} in ${process.env.BACKEND_REPO}`);
              return;
            }

            const artifacts = await github.request(
              "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
              {
                owner,
                repo,
                run_id: run.id,
                per_page: 100,
                headers: { authorization: `Bearer ${token}` },
              },
            );
            const artifact = artifacts.data.artifacts?.find((a) => a.name === "openapi-json");
            if (!artifact) {
              core.setFailed(`Backend run ${run.id} has no artifact named openapi-json`);
              return;
            }
            core.setOutput("run_id", String(run.id));

      - name: Find backend OpenAPI artifact run (main)
        if: ${{ github.event_name != 'pull_request' }}
        id: backend-run-main
        uses: actions/github-script@v7
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
          GH_TOKEN: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
        with:
          script: |
            const [owner, repo] = process.env.BACKEND_REPO.split("/");
            const token = process.env.GH_TOKEN;

            const runs = await github.request("GET /repos/{owner}/{repo}/actions/runs", {
              owner,
              repo,
              branch: "main",
              status: "completed",
              per_page: 50,
              headers: { authorization: `Bearer ${token}` },
            });

            const run = runs.data.workflow_runs?.find((r) => r.conclusion === "success");
            if (!run) {
              core.setFailed(`No successful backend workflow run found on branch=main in ${process.env.BACKEND_REPO}`);
              return;
            }

            const artifacts = await github.request(
              "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
              {
                owner,
                repo,
                run_id: run.id,
                per_page: 100,
                headers: { authorization: `Bearer ${token}` },
              },
            );
            const artifact = artifacts.data.artifacts?.find((a) => a.name === "openapi-json");
            if (!artifact) {
              core.setFailed(`Backend run ${run.id} on main has no artifact named openapi-json`);
              return;
            }
            core.setOutput("run_id", String(run.id));

      - name: Download backend OpenAPI artifact
        id: download-openapi
        uses: dawidd6/action-download-artifact@v6
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
        with:
          github_token: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
          repo: ${{ env.BACKEND_REPO }}
          run_id: ${{ steps.backend-run.outputs.run_id || steps.backend-run-main.outputs.run_id }}
          name: openapi-json
          path: openapi-artifact

      - name: Export OPENAPI_SPEC_PATH from artifact
        run: |
          set -euo pipefail
          OPENAPI_PATH="$(find openapi-artifact -name openapi.json -print -quit || true)"
          if [ -z "$OPENAPI_PATH" ]; then
            echo "::error::openapi.json not found in downloaded artifact"
            find openapi-artifact -maxdepth 4 -type f -print
            exit 1
          fi
          echo "OPENAPI_SPEC_PATH=$(realpath "$OPENAPI_PATH")" >> "$GITHUB_ENV"

      - name: Preflight OpenAPI source
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.backend-run.outputs.run_id || steps.backend-run-main.outputs.run_id }}"
          echo "Using backend OpenAPI artifact:"
          echo "- repo: ${{ env.BACKEND_REPO }}"
          echo "- run_id: ${RUN_ID}"
          echo "- openapi: ${OPENAPI_SPEC_PATH}"

      - name: Typecheck
        run: npm run typecheck --if-present

      - name: Lint
        run: npm run lint --if-present

      - name: Check generated API types
        run: npm run check:api-types

      - name: Contract drift tests (CT-2)
        run: npm run ct-2

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build
