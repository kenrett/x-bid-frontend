name: Frontend CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  secret_scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # v4.1.7
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Run gitleaks
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:v8.24.2 git /repo --redact --verbose --exit-code 1

  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        # v4.1.7
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Node
        # v4.0.2
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit production dependencies
        run: npm audit --omit=dev

      - name: Find backend OpenAPI artifact run (PR)
        if: ${{ github.event_name == 'pull_request' }}
        id: backend-run
        # v7
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
          BACKEND_OPENAPI_ARTIFACT_NAME: ${{ vars.BACKEND_OPENAPI_ARTIFACT_NAME || 'openapi-json' }}
          GH_TOKEN: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
        with:
          script: |
            const [owner, repo] = process.env.BACKEND_REPO.split("/");
            const headSha = context.payload.pull_request.head.sha;
            const token = process.env.GH_TOKEN;
            const artifactName = process.env.BACKEND_OPENAPI_ARTIFACT_NAME || "openapi-json";

            const runs = await github.request("GET /repos/{owner}/{repo}/actions/runs", {
              owner,
              repo,
              event: "pull_request",
              head_sha: headSha,
              per_page: 50,
              headers: { authorization: `Bearer ${token}` },
            });
            const candidates = runs.data.workflow_runs ?? [];
            if (!candidates.length) {
              core.setFailed(`No backend workflow run found for head_sha=${headSha} in ${process.env.BACKEND_REPO}`);
              return;
            }

            const maxChecks = 10;
            for (const run of candidates.slice(0, maxChecks)) {
              const artifacts = await github.request(
                "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
                {
                  owner,
                  repo,
                  run_id: run.id,
                  per_page: 100,
                  headers: { authorization: `Bearer ${token}` },
                },
              );
              const found = artifacts.data.artifacts?.find((a) => a.name === artifactName);
              if (found) {
                core.setOutput("run_id", String(run.id));
                core.setOutput("artifact_name", artifactName);
                return;
              }
            }

            const latest = candidates[0];
            const latestArtifacts = await github.request(
              "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
              {
                owner,
                repo,
                run_id: latest.id,
                per_page: 100,
                headers: { authorization: `Bearer ${token}` },
              },
            );
            const names =
              latestArtifacts.data.artifacts?.map((a) => a.name).join(", ") || "(none)";
            core.setFailed(
              `No backend PR run (head_sha=${headSha}) had artifact '${artifactName}'. Latest run ${latest.id} artifacts: ${names}`,
            );

      - name: Find backend OpenAPI artifact run (main)
        if: ${{ github.event_name != 'pull_request' }}
        id: backend-run-main
        # v7
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
          BACKEND_OPENAPI_ARTIFACT_NAME: ${{ vars.BACKEND_OPENAPI_ARTIFACT_NAME || 'openapi-json' }}
          GH_TOKEN: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
        with:
          script: |
            const [owner, repo] = process.env.BACKEND_REPO.split("/");
            const token = process.env.GH_TOKEN;
            const artifactName = process.env.BACKEND_OPENAPI_ARTIFACT_NAME || "openapi-json";

            const runs = await github.request("GET /repos/{owner}/{repo}/actions/runs", {
              owner,
              repo,
              branch: "main",
              status: "completed",
              per_page: 50,
              headers: { authorization: `Bearer ${token}` },
            });

            const candidates = (runs.data.workflow_runs ?? []).filter(
              (r) => r.conclusion === "success",
            );
            if (!candidates.length) {
              core.setFailed(`No successful backend workflow run found on branch=main in ${process.env.BACKEND_REPO}`);
              return;
            }

            const maxChecks = 10;
            for (const run of candidates.slice(0, maxChecks)) {
              const artifacts = await github.request(
                "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
                {
                  owner,
                  repo,
                  run_id: run.id,
                  per_page: 100,
                  headers: { authorization: `Bearer ${token}` },
                },
              );
              const found = artifacts.data.artifacts?.find((a) => a.name === artifactName);
              if (found) {
                core.setOutput("run_id", String(run.id));
                core.setOutput("artifact_name", artifactName);
                return;
              }
            }

            const latest = candidates[0];
            const latestArtifacts = await github.request(
              "GET /repos/{owner}/{repo}/actions/runs/{run_id}/artifacts",
              {
                owner,
                repo,
                run_id: latest.id,
                per_page: 100,
                headers: { authorization: `Bearer ${token}` },
              },
            );
            const names =
              latestArtifacts.data.artifacts?.map((a) => a.name).join(", ") || "(none)";
            core.setFailed(
              `No successful backend main run had artifact '${artifactName}'. Latest run ${latest.id} artifacts: ${names}`,
            );

      - name: Download backend OpenAPI artifact
        id: download-openapi
        env:
          BACKEND_REPO: ${{ vars.BACKEND_REPO || format('{0}/{1}', github.repository_owner, 'x-bid-backend') }}
        # v4.1.8
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          github-token: ${{ secrets.BACKEND_CI_TOKEN || github.token }}
          repository: ${{ env.BACKEND_REPO }}
          run-id: ${{ steps.backend-run.outputs.run_id || steps.backend-run-main.outputs.run_id }}
          name: ${{ steps.backend-run.outputs.artifact_name || steps.backend-run-main.outputs.artifact_name || 'openapi-json' }}
          path: openapi-artifact

      - name: Export OPENAPI_SPEC_PATH from artifact
        run: |
          set -euo pipefail
          OPENAPI_PATH="$(find openapi-artifact -name openapi.json -print -quit || true)"
          if [ -z "$OPENAPI_PATH" ]; then
            echo "::error::openapi.json not found in downloaded artifact"
            find openapi-artifact -maxdepth 4 -type f -print
            exit 1
          fi
          echo "OPENAPI_SPEC_PATH=$(realpath \"$OPENAPI_PATH\")" >> "$GITHUB_ENV"

      - name: Preflight OpenAPI source
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.backend-run.outputs.run_id || steps.backend-run-main.outputs.run_id }}"
          echo "Using backend OpenAPI artifact:"
          echo "- repo: ${{ env.BACKEND_REPO }}"
          echo "- run_id: ${RUN_ID}"
          echo "- openapi: ${OPENAPI_SPEC_PATH}"

      - name: Typecheck
        run: npm run typecheck --if-present

      - name: Lint
        run: npm run lint --if-present

      - name: Check generated API types
        run: npm run check:api-types

      - name: Contract drift tests (CT-2)
        run: npm run ct-2

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build
